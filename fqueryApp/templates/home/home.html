<html>
    <head>
        Welcome to fQuery HOME page!
    </head>
    <body>

        <div id="fb-root"></div>
        <div>
          <fb:login-button
            show-faces="false"
            width="200"
            max-rows="1"
            autologoutlink="true"
            scope="user_status, friends_status">
          </fb:login-button>
        </div>


        <div id = "friend_list_div"></div>
        <div id = "status_list_div"></div>

        <script>
            // Log to console
            function log(msg) {
                console.log(msg);
            }

            function get_friend_list(){
                log('Fetching your friend list...');
                FB.api('/me/friends', function(response){
                    log("Total of " + response.data.length + " friends.");

                    // Display friend list.
                    var friend_list_li = document.createElement("ul");
                    for (var i = 0; i < response.data.length; ++i){
                        // log("")
                        console.log("Processing " + response.data[i].name);
                        var one_friend_element = document.createElement("li");
                        one_friend_element.innerHTML =  response.data[i].id + " " +
                                                        response.data[i].name;
                        friend_list_li.appendChild(one_friend_element);
                    }

                    document.getElementById("friend_list_div").appendChild(friend_list_li)

                });
            }



            // Get user statuses and display them.
            function get_statuses () {
                log('Fetching your statuses ...');
                FB.api('/me/statuses', function (response) {
                    status_list = response.data;

                    var status_list_ul = document.createElement("ul");
                    for (var i = 0; i < status_list.length; ++i){
                        
                        // console.log("Processing " + response.data[i].name);
                        var status_li = document.createElement("li");
                        status_li.innerHTML = status_list[i].message;
                        status_list_ul.appendChild(status_li);
                    }

                    document.getElementById("status_list_div").appendChild(status_list_ul)
                    // save_statuses(status_list);
                })


            }

            function save_statuses (status_list) {
                $.post(
                    "{% url 'home:store_user_statuses' %}",
                    JSON.stringify(friend_list),
                    function(server_response) {
                      log(server_response);
                    }
                  );  
            }



            window.fbAsyncInit = function() {
                FB.init({
                  appId      : '{{ FACEBOOK_APP_ID }}',
                  status     : true,
                  xfbml      : true
                });
          

                FB.Event.subscribe('auth.authResponseChange', function(response) {
                    if (response.status === 'connected') {
                      testAPI();
                      console.log("Logged in!");

                    } else {
                      window.location = "{% url 'fqueryApp:render_login' %}";
                      console.log("Not loggedin");
                    }
                  });
            };



          (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/all.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));


          function testAPI(){
              console.log('Welcome!  Fetching your information.... ');
              FB.api('/me', function(response) {
                console.log('Good to see you, ' + response.name + '.');
                window.my_id = response.id;
                window.my_name = response.name;
                console.log('ID: ', response.id);
              })
              // get_friend_list();
              get_statuses();
          }
        </script>
    
    </body>
</html>